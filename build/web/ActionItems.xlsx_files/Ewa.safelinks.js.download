Type.registerNamespace("Common.App.SafeLinks");Common.App.SafeLinks.b=function(n,t,i,r,u){this.IsSafeLinksEnabled=null;this.WebAffinitizedUrl=null;this.PolicyCookie=null;this.PolicyCookieTTL=0;this.WasServiceDown=!1;this.IsSafeLinksEnabled=n;this.WebAffinitizedUrl=t;this.PolicyCookie=i;this.PolicyCookieTTL=r;this.WasServiceDown=u};Common.App.SafeLinks.SafeLinksManager=function(n,t,i,r,u,f){var o,s,a,h;if(this.u=Function.createDelegate(this,this.F),this.v=Function.createDelegate(this,this.G),Diag.a.a(26019598,378,100,"Initializing SafeLinksManager."),this.b=n,this.s=t,this.o=i,Common.App.SafeLinks.SafeLinksManager.b=f,this.q=r?this.b.i.SafeLinksHandlerWebServiceBase:this.b.i.WebServiceBase,this.p=this.b.i.SafeLinksHashedUserId,this.t=this.b.i.SafeLinksWorkloadIdHeaderValue,this.i=this.b.b("SafeLinksMaxGetPolicyBootRetries",2),this.j=this.b.b("SafeLinksMaxGetPolicyOnLinkClickRetries",1),this.g=this.K(),this.f=this.J(),Diag.a.a(26019599,378,50,"SafeLinksManager _isEnabledForUser={0}, _isEnabledForBrowser={1}",this.g,this.f),this.g&&this.f){var e=this.n(),c=e?e.IsSafeLinksEnabled.toLowerCase():"",l=this.x();Diag.a.a(36231312,378,50,"Cached values for IsSafeLinksEnabled: {0}, IsPolicyCookieExpired: {1}.",c,l);o=!e||c==="unknown"||e.WasServiceDown||l;s=new Map;s.set("shouldGetSafeLinksDataFromServer",o.toString());s.set("isSafeLinksEnabledCacheValue",c.toString());Common.s.a().recordKpiUsage("SafeLinksGetPolicy",0,"jpittsdirects",s);a=this.b.e("LicensingForSafeLinksIsEnabled")?this.b.a("LicensingForSafeLinksIsEnabled"):!1;a&&u?(this.h=!1,h=this,u.a(function(n){n.a("MsoUrlreputation",!0).then(function(n){return h.h=n,h.h&&o&&h.r(!0),null})})):o&&this.r(!0)}};Common.App.SafeLinks.SafeLinksManager.c=function(n){return n.toLowerCase()!=="false"?!0:!1};Common.App.SafeLinks.SafeLinksManager.prototype={b:null,s:null,t:null,q:null,p:null,o:null,i:0,j:0,d:0,e:0,l:!1,k:!1,c:null,h:!0,g:!1,f:!1,m:null,C:function(){var t=this.q?this.q+"/":"",n=new Common.bw("SafeLinksHandler.ashx");return n.a("app",this.o),this.b.a("SafeLinksUseDebugHeader")&&n.a("action","debug"),String.format("{0}{1}&{2}",t,n.toString(),Common.a.j)},a:function(n){var i,t,r,u,f;return n?(i=this.I(n),Diag.a.a(594830615,378,50,"SafeLinksManager.TryNavigate: isSupportedHyperLinkType={0},_isEnabledForUser={1},_isEnabledForBrowser={2},_isUserLicensedForSafeLinks={3}",i,this.g,this.f,this.h),!i||!this.g||!this.f||!this.h)?!1:(Common.s.a().recordKpiUsage("SafeLinksNavigations",0,"jpittsdirects",null),t=0,f=(u=this.L(r={val:t}),t=r.val,u),Diag.a.a(595079385,378,50,"ShouldTryUsingSafeLinksService returned NavigationState={0}",Common.App.SafeLinks.SafeLinksManager.a.toString(t)),!f)?(Common.s.a().recordKpiFailure("SafeLinksNavigations",Common.App.SafeLinks.SafeLinksManager.a.toString(t),t===1,!0,null),!1):(Diag.a.a(26019601,378,50,"Using safelinks to navigate hyperlink"),!this.x())?(this.A(n),!0):(this.c=n,Diag.a.a(24462627,378,50,"Refreshing the cache as policy cookie expired."),this.k=!1,this.r(!1),!0):(Diag.a.a(593367827,378,10,"SafeLinksManager.TryNavigate: Null/Empty targetUrl"),!1)},I:function(n){var t,i;if(n=n.toLowerCase(),t=this.b.g("SafeLinksUnsupportedProtocols"),t)for(i=0;i<t.length;i++)if(n.startsWith(t[i]))return!1;return!0},r:function(n){var t=new Map,i;t.set("isOnBootRequest",n.toString());Common.s.a().recordKpiUsage("SafeLinksGetPolicySuccessfulRequest",1,"jpittsdirects",t);Common.s.a().recordKpiUsage("SafeLinksGetPolicyFailedRequest",0,"jpittsdirects",t);i=this.B("SafeLinksGetPolicy");this.s.a(this.C(),1,null,null,!0,2,this.v,this.u,i,null,!1,null,null,"23",null,!1,null,!1,null);this.k=n;this.l=!0;n?this.d++:this.e++},G:function(n){var u=406,i="",t,r,l,a,v;try{this.k=!1;this.l=!1;var o=n.b.f,s,h,c=(h=this.z(s={val:o}),o=s.val,h),f,y=(f=new Common.cc,f.durationMs=c,f);if(Common.s.a().recordKpiSuccess("SafeLinksGetPolicySuccessfulRequest",y),Diag.a.a(594830614,378,50,"GetSafeLinksDataFromServer_OnSuccessCallback: HttpStatus {0}, data length {1}, Duration {2}",n.b.c,n.b.a.length,c),n.b.c!==200){i="Unexpected httpStatus: "+n.b.c.toString();return}t=null;try{t=JSON.parse(n.b.a)}catch(p){i="Exception:"+p.toString()+" deserializing response: "+n.b.a;return}if(!t){i="Error when serializing response into SafeLinksData. SafeLinksData is null.";return}if(r=t.IsSafeLinksEnabled,isNullOrUndefined(r)||r.length<=0){i="Invalid isSafeLinksEnabledString";return}if(Diag.a.a(594830613,378,50,"Retrieved isSafeLinksEnabledString {0}",r),l=Common.App.SafeLinks.SafeLinksManager.c(r),isNullOrUndefined(t.WebAffinitizedUrl)||t.WebAffinitizedUrl.length<=0){i="Invalid WebAffinitizedUrl";return}if(isNullOrUndefined(t.PolicyCookie)||t.PolicyCookie.length<=0){i="Invalid PolicyCookie";return}if(isNullOrUndefined(t.PolicyCookieTTL)){i="Invalid PolicyCookieTTL";return}var w=t.WebAffinitizedUrl,b=t.PolicyCookie,e=new Date,k=t.PolicyCookieTTL>5?t.PolicyCookieTTL-5:0;e.setMinutes(e.getMinutes()+k);a=e.getTime();v=new Common.App.SafeLinks.b(r,w,b,a,!1);this.y(v);u=n.b.c;this.c&&(l?(this.A(this.c),this.d=0,this.e=0):(Diag.a.a(26019602,378,50,"SafeLinks is disabled by admin; Navigating without SafeLinks"),Common.s.a().recordKpiFailure("SafeLinksNavigations",Common.App.SafeLinks.SafeLinksManager.a.toString(1),!0,!0,null),Common.g.e(this.c)),this.c=null)}catch(d){i="GetSafeLinksDataFromServer_OnSuccessCallback: Exception:  "+d.toString()}finally{u!==200&&this.w(u,i)}},F:function(n){var i,t;this.l=!1;i=500;t="";try{var u=n.b.f,f,e,o=(e=this.z(f={val:u}),u=f.val,e),r,s=(r=new Common.cc,r.durationMs=o,r);i=n.b.c;Common.s.a().recordKpiFailure("SafeLinksGetPolicyFailedRequest","HttpStatusCode_"+i.toString(),!1,!0,s);t="Request Failed, Status="+Common.ch.toString(n.b.b)+" Duration: "+o;isNullOrUndefined(n.b.a)||(t+=" ResponseData=",t+=n.b.a.substring(0,Math.min(n.b.a.length,100)))}catch(h){t="GetSafeLinksDataFromServer_OnFailureCallback Exception: "+h.toString()}finally{this.w(i,t)}},w:function(n,t){var r,i,u;try{Diag.a.a(594830612,378,10,"HandleGetPolicyRequestError: HttpStatus {0}, Error {1}",n,t);this.d<this.i&&this.e<this.j?this.r(this.k):(this.k=!1,Diag.a.a(24462656,378,10,"Exhausted all retries for SafeLinks GetPolicy call. OnBootRetries: {0}, OnClickRetries: {1}, HttpStatus: {2}, Error: {3}",this.d,this.e,n,t),i=(r=new Common.cc,r.extendedProperties=new Map,r),i.extendedProperties.set("HttpStatus",n.toString()),i.extendedProperties.set("ErrorMessage",t),Common.s.a().recordKpiFailure("SafeLinksGetPolicy","GetPolicyRequestError",!1,!0,i),u=new Common.App.SafeLinks.b("false","","",0,!0),this.y(u),this.c&&(Diag.a.a(26019603,378,50,"Error occured during at-click GetPolicy call, NavigationState = {0}",Common.App.SafeLinks.SafeLinksManager.a.toString(2)),Common.s.a().recordKpiFailure("SafeLinksNavigations",Common.App.SafeLinks.SafeLinksManager.a.toString(2),!1,!0,null),Common.g.e(this.c),this.c=null))}catch(f){Diag.a.a(594830611,378,10,"HandleGetPolicyRequestError: Exception {0}",f.toString())}},A:function(n){var i=this.E(),r=this.H(),t={};t.Url=n;t.SafeLinksCookie=i;t.CorrelationId=Common.z.a().a;t.WorkloadId=this.t;t.UserAgentInfo=Common.c.V()+"|"+this.o;Diag.a.a(23900187,378,50,"Validating hyperlink with request correlation: {0}",t.CorrelationId);Common.g.r(Common.g.f(4),r,t)},K:function(){var n=this.b.i.IsSafeLinksEnabledForUser;return n?Common.App.SafeLinks.SafeLinksManager.c(n):!1},J:function(){var n=this.b.g("SafeLinksDisabledBrowsers");return n&&Common.c.z()&&Array.contains(n,"Electron")?!1:!0},L:function(n){var t,i,r;return(n.val=0,t=this.n(),i=t?t.IsSafeLinksEnabled:"",i!=="")?t.WasServiceDown?(Diag.a.a(51663971,378,50,"Failed to retrieve policy data"),n.val=2,!1):i.toLowerCase()==="false"?(Diag.a.a(51664e3,378,50,"SafeLinks disabled for the user"),n.val=1,!1):Common.App.SafeLinks.SafeLinksManager.c(i):this.l?(n.val=3,Diag.a.a(595079384,378,50,"Currently getting SafeLinks policy"),!1):this.d>=this.i||this.e>=this.j?(n.val=2,Diag.a.a(51664001,378,50,"Exhausted all retries- Failure in GetPolicy for SafeLinks ({0}/{1} boot, {2}/{3} onClick)",this.d,this.i,this.e,this.j),!1):(r=this.d+this.e,Diag.a.a(23900182,378,10,"Inconsistent SafeLinks state: SafeLinks cache data is null with no on boot request pending, and {0} retries left over. Perhaps LocalStorage is inaccessable.",this.i+this.j-r),!0)},E:function(){var n=this.n();return n?n.PolicyCookie:""},H:function(){var n=this.n();return n?n.WebAffinitizedUrl:""},D:function(){var t=new Date,n,i;try{n=this.n();i=n?n.PolicyCookieTTL:0;t.setTime(i)}catch(r){Diag.a.a(24462658,378,10,"Exception occured while fetching expiration time from cache: {0}",r)}return t},x:function(){var n=this.D();return!!n&&n.getTime()<Date.now()},n:function(){if(!this.m){var n=Common.Utils.c.a().d(this.p);if(!n||n==="")return null;this.m=JSON.parse(n)}return this.m},y:function(n){if(isNullOrUndefined(n))throw Error.argumentNull("safeLinksData");else if(isNullOrUndefined(n.IsSafeLinksEnabled)||n.IsSafeLinksEnabled.length<=0)throw Error.argumentNull("safeLinksData.IsSafeLinksEnabled");this.m=n;n.WasServiceDown||this.M(n)},M:function(n){var t=JSON.stringify(n);Common.Utils.c.a().a(this.p,t)},B:function(n){return isNullOrUndefined(Common.App.SafeLinks.SafeLinksManager.b)?null:Common.App.SafeLinks.SafeLinksManager.b.a("WebServiceCall",n)},z:function(n){if(!isNullOrUndefined(n.val)){var t=n.val.b();return n.val.a(),n.val=null,t}return null}};Common.App.SafeLinks.SafeLinksManager.a=function(){};Common.App.SafeLinks.SafeLinksManager.a.prototype={enabledByPolicy:0,disabledByPolicy:1,disabled_GetPolicyFailure:2,disabled_PendingGetPolicyRequest:3};Common.App.SafeLinks.SafeLinksManager.a.registerEnum("Common.App.SafeLinks.SafeLinksManager.a",!1);Common.App.SafeLinks.c=function(){};Common.App.SafeLinks.c.b=function(n){switch(n){case 3:return"Word";case 2:return"PowerPoint";case 1:return"Excel";default:return"Unknown"}};Common.App.SafeLinks.c.a=function(n){switch(n){case 1:return"Edit";case 2:return"View";case 3:return"InstantView";default:return"Unknown"}};Common.App.SafeLinks.b.registerClass("Common.App.SafeLinks.b");Common.App.SafeLinks.SafeLinksManager.registerClass("Common.App.SafeLinks.SafeLinksManager",null,Common.App.SafeLinks.a);Common.App.SafeLinks.SafeLinksManager.b=null;Type.registerNamespace("_Ewa");_Ewa.xl=function(n){_Ewa.xl.initializeBase(this);this.h=n;this.j()};_Ewa.xl.a=function(n){n.b().b(_Ewa.baR.$$(Common.App.SafeLinks.a),270,new _Ewa.xl(n))};_Ewa.xl.prototype={h:null,b:function(){this.i(this.h.b().a(Common.App.SafeLinks.a,269,!1)||new Common.App.SafeLinks.SafeLinksManager(Common.a.a,Common.a.d,String.format("{0}-{1}",Common.App.SafeLinks.c.b(Common.a.b().a().c()),Common.App.SafeLinks.c.a(Common.a.b().a().o())),!1,null,null))}};_Ewa.xl.registerClass("_Ewa.xl",_Ewa.pZ.$$(Common.App.SafeLinks.a));Type.registerNamespace("_Ewa");_Ewa.bdt=function(){};_Ewa.bdt.a=function(){_Ewa.j.a(function(n){_Ewa.xl.a(n)})};_Ewa.bdt.a();